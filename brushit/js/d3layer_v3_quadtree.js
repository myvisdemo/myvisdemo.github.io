define(["dojo/_base/declare","esri/geometry/Point","dojo/_base/lang","esri/layers/GraphicsLayer","js/lib/d3.js"],function(t,n,p,q,d){return q.createSubclass({constructor:function(b,a){this.url=b;this.callback=a.callback||function(){};this.svg_type=a.svgType||"path";this.id=a.id||Date.now().toString(16);this._styles=a.style||[];this._attrs=a.attr||[];this._svg_layer_sel="#"+this.id+"_layer";this.secell=20;this.unitRadius=4;this.isClustering=a.isClustering},_setMap:function(b,a){var c=this;d.json(c.url,
function(a){c.geoFeatures=a;c.bbox=d.geo.bounds(c.geojson);c.loaded=!0;c._render();c.onLoad(c);c.callback(a)});this.mapWidth=b.width;this.mapHeight=b.height;this._redraw=b.on("zoom-end",p.hitch(this,function(){this.redraw()}));this._path_draw=d.geo.path().projection(d.geo.mercator().scale((b.width+1)/2/Math.PI).translate([b.width/2,b.height/2]).precision(.1));return this.inherited(arguments)},_unsetMap:function(){this.inherited(arguments);this._redraw.remove()},attr:function(b){("data-suspended"!=
b||this.suspended)&&this.getSVGFeatureSelections().attr(b.key,b.value);return this.inherited(arguments)},_render:function(){var b=this,a=this.getSVGFeatureGroupSelections();if(this.isClustering){this.quadtree=d.geom.quadtree().x(function(a){return a.x}).y(function(a){return a.y})(this._initClusteringArray(this.geoFeatures.features));var c=this.clustering();a=a.data(c,function(a){return a?Math.floor(a.x)+"_"+Math.floor(a.y)+"_"+a.r+"_"+a.index:"null"}).enter().append("g");c=a.append(this.svg_type).attr("r",
function(a){return a.r});"path"!==this.svg_type&&a.attr("transform",function(a){return"translate("+a.x+","+a.y+")"});this._attrs.forEach(function(a){c.attr(a.name,a.value)});c.attr("class",function(a,f){return d.select(this).attr("class")+" "+b.id});this._styles.forEach(function(a){c.style(a.name,a.value)})}else a=a.data(this.geoFeatures.features).enter().append("g").attr("class",b.id),c=a.append(this.svg_type),"path"==this.svg_type?c.attr("d",this._path_draw):a.attr("transform",function(a){return"translate("+
b._project_to_screen(a.geometry.coordinates)[0]+","+b._project_to_screen(a.geometry.coordinates)[1]+")"}),this._attrs.forEach(function(a){c.attr(a.name,a.value)}),c.attr("class",function(a,f){return d.select(this).attr("class")+" "+b.id}),this._styles.forEach(function(a){c.style(a.name,a.value)})},redraw:function(){var b=this;if(this.isClustering){if("path"!=this.svg_type){var a=this.getSVGFeatureGroupSelections();this.quadtree=d.geom.quadtree().x(function(a){return a.x}).y(function(a){return a.y})(this._initClusteringArray(this.geoFeatures.features));
var c=this.clustering();a=a.data(c,function(a){return a?Math.floor(a.x)+"_"+Math.floor(a.y)+"_"+a.r+"_"+a.index:"null"});a.selectAll("g").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});a.selectAll("g "+b.svg_type).attr("r",function(a){return a.r});var e=a.enter().append("g").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).append(this.svg_type).attr("r",function(a){return a.r});this._attrs.forEach(function(a){e.attr(a.name,a.value)});this._styles.forEach(function(a){e.style(a.name,
a.value)});e.call(d.helper.attractiontip());a.exit().remove()}}else"path"!=this.svg_type?this.getSVGFeatureGroupSelections().attr("transform",function(a){return"translate("+b._project_to_screen(a.geometry.coordinates)[0]+","+b._project_to_screen(a.geometry.coordinates)[1]+")"}):this.getSVGFeatureSelections().attr("d",b._path_draw)},getSVGLayerSelector:function(){return this._svg_layer_sel},getSVGFeatureSelections:function(){return d.select(this._svg_layer_sel).selectAll(this.svg_type)},getSVGFeatureGroupSelections:function(){return d.select(this._svg_layer_sel).selectAll("g")},
_project_to_screen:function(b){b=new n(b[0],b[1]);b=this._map.toScreen(b);return[b.x,b.y]},_initClusteringArray:function(b){var a=this;return b.map(function(b,d){var c=a._project_to_screen(b.geometry.coordinates);return{x:c[0],y:c[1],r:a.unitRadius,points:[b]}})},_averageClusters:function(b,a){var c=a.r/(b.r+a.r);return{x:b.x+c*(a.x-b.x),y:b.y+c*(a.y-b.y),r:this.unitRadius*Math.sqrt(b.points.length+a.points.length),points:b.points.concat(a.points)}},clustering:function(){function b(a,b,c,d,e){var l=
[];a.visit(function(a,r,f,g,h){if(a=a.point)a.selected=a.x>=b&&a.x<d&&a.y>=c&&a.y<e,a.selected&&l.push(a);return r>=d||f>=e||g<b||h<c});return l}for(var a=this,c=[],e=0;e<=a.mapWidth;e+=a.secell)for(var f=0;f<=a.mapHeight;f+=a.secell){var m=b(a.quadtree,e,f,e+a.secell,f+a.secell);m.length&&c.push(m.reduce(a._averageClusters.bind(a)))}var g=d.max(c,function(a){return a.r}),h=!0;for(c.map(function(a,b){a.index=b;return a});h;){h=!1;var k=[];d.geom.voronoi().x(function(a){return a.x+Math.random()-.5}).y(function(a){return a.y+
Math.random()-.5}).links(c.filter(function(a){return!!a})).map(function(a){var b=a.source.x-a.target.x,c=a.source.y-a.target.y;a.distance=Math.sqrt(b*b+c*c);k.push(a)});k.sort(function(a,b){return a.distance-b.distance});k.every(function(b){if(b.distance>2*g)return!1;if(b.distance<b.source.r+b.target.r){h=!0;var d=a._averageClusters(b.source,b.target);d.index=b.source.index;c[b.target.index]=null;c[b.source.index]=d;g=Math.max(g,d.r);return!1}return!0})}return c.filter(function(a){return null!==a})}})});